#!/usr/bin/env node
/**
 * Sync enum definitions from Prisma schema into shared-types package.
 * Ensures a single source of truth for cross-application enums.
 */

const fs = require('fs');
const path = require('path');

const ENUMS = [
  { name: 'UserRole', file: 'user-role.enum.ts' },
  { name: 'NotificationType', file: 'notification-type.enum.ts' },
  { name: 'StreamStatus', file: 'stream-status.enum.ts' },
  { name: 'AnalyticsEventType', file: 'analytics-event-type.enum.ts' },
];

const repoRoot = path.resolve(__dirname, '..');
const schemaPath = path.join(repoRoot, 'apps', 'backend', 'prisma', 'schema.prisma');
const enumsDir = path.join(repoRoot, 'packages', 'shared-types', 'src', 'enums');

const schema = fs.readFileSync(schemaPath, 'utf8');

function extractEnumValues(enumName) {
  const enumRegex = new RegExp(`enum\\s+${enumName}\\s*{([\\s\\S]*?)}`, 'm');
  const match = schema.match(enumRegex);
  if (!match) {
    throw new Error(`Enum "${enumName}" was not found in schema.prisma`);
  }

  return match[1]
    .split('\n')
    .map((line) => line.trim())
    .filter(Boolean)
    .filter((line) => !line.startsWith('//'))
    .map((line) => line.replace(/[,]|\\s+/g, ' ').split(' ')[0])
    .filter(Boolean);
}

function toEnumFile(enumName, values) {
  const entries = values
    .map((value) => `  ${value} = '${value}',`)
    .join('\n');

  const listName = `${enumName}Values`;
  const list = values.map((value) => `'${value}'`).join(', ');

  return `// This file is auto-generated by scripts/sync-prisma-enums.js. Do not edit manually.

export enum ${enumName} {
${entries}
}

export const ${listName} = [${list}] as const;
`;
}

if (!fs.existsSync(enumsDir)) {
  fs.mkdirSync(enumsDir, { recursive: true });
}

for (const { name, file } of ENUMS) {
  const values = extractEnumValues(name);
  const filePath = path.join(enumsDir, file);
  fs.writeFileSync(filePath, toEnumFile(name, values));
  console.log(`Synced enum ${name} -> ${path.relative(repoRoot, filePath)}`);
}

